name: Build and Package

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-windows:
    name: Build Windows Application
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # èŽ·å–å®Œæ•´åŽ†å²ä»¥åˆ†æž commits

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Calculate semantic version
        id: semver
        run: |
          # èŽ·å–æœ€è¿‘çš„ tag
          git fetch --tags --force
          $LATEST_TAG = git describe --tags --abbrev=0 2>$null

          if (-not $LATEST_TAG) {
            # æ²¡æœ‰ä»»ä½• tagï¼Œä»Ž 0.0 å¼€å§‹
            $LATEST_TAG = "v0.0"
          }

          # è§£æžç‰ˆæœ¬å· (æ”¯æŒ x.x å’Œ x.x.x æ ¼å¼ï¼Œç»Ÿä¸€è½¬ä¸º x.x)
          if ($LATEST_TAG -match '^v?(\d+)\.(\d+)') {
            $MAJOR = [int]$matches[1]
            $MINOR = [int]$matches[2]
          } else {
            $MAJOR = 0
            $MINOR = 0
          }

          echo "ðŸ“Œ æœ€è¿‘ç‰ˆæœ¬: $LATEST_TAG ($MAJOR.$MINOR)"

          # æ£€æŸ¥å½“å‰ commit æ˜¯å¦æœ‰ tagï¼ˆå·²å‘å¸ƒç‰ˆæœ¬ï¼‰
          $CURRENT_TAG = git describe --exact-match --tags 2>$null
          if ($CURRENT_TAG) {
            # ç»Ÿä¸€è½¬æ¢ä¸º x.x æ ¼å¼
            if ($CURRENT_TAG -match '^v?(\d+)\.(\d+)') {
              $VERSION = "$($matches[1]).$($matches[2])"
            } else {
              $VERSION = $CURRENT_TAG -replace '^v', ''
            }
            $IS_RELEASE = "true"
            echo "âœ“ å·²å‘å¸ƒç‰ˆæœ¬: $VERSION"
          } else {
            # åˆ†æžä»Žæœ€è¿‘ tag åˆ°çŽ°åœ¨çš„æ‰€æœ‰ commits
            $COMMITS = git log "$LATEST_TAG..HEAD" --pretty=format:"%s" 2>$null
            if (-not $COMMITS) {
              # å¦‚æžœæ²¡æœ‰ commitsï¼Œå¯èƒ½æ˜¯åˆå§‹åŒ–çŠ¶æ€
              $COMMITS = git log --pretty=format:"%s"
            }

            $HAS_BREAKING = $false
            $HAS_FEAT = $false

            # åˆ†æž commit messages
            foreach ($msg in $COMMITS) {
              # BREAKING CHANGE æˆ– feat!: è¡¨ç¤ºé‡å¤§å˜æ›´
              if ($msg -match '(BREAKING CHANGE|!:)') {
                $HAS_BREAKING = $true
              }
              # feat: æ–°åŠŸèƒ½
              if ($msg -match '^feat(\(.+\))?!?:') {
                $HAS_FEAT = $true
              }
            }

            # æ ¹æ® Conventional Commits è®¡ç®—ç‰ˆæœ¬å· (x.x æ ¼å¼)
            if ($HAS_BREAKING) {
              # BREAKING CHANGE -> Major ç‰ˆæœ¬é€’å¢ž
              $MAJOR += 1
              $MINOR = 0
              echo "ðŸ”¥ æ£€æµ‹åˆ° BREAKING CHANGE -> MAJOR ç‰ˆæœ¬é€’å¢ž"
            } elseif ($HAS_FEAT) {
              # æ–°åŠŸèƒ½ -> Minor ç‰ˆæœ¬é€’å¢ž
              $MINOR += 1
              echo "âœ¨ æ£€æµ‹åˆ°æ–°åŠŸèƒ½ -> MINOR ç‰ˆæœ¬é€’å¢ž"
            } else {
              # å…¶ä»–å˜æ›´ï¼ˆfix, chore, docs ç­‰ï¼‰-> Minor ç‰ˆæœ¬é€’å¢ž
              $MINOR += 1
              echo "ðŸ“¦ å…¶ä»–å˜æ›´ -> MINOR ç‰ˆæœ¬é€’å¢ž"
            }

            $COMMIT_COUNT = ($COMMITS | Measure-Object).Count
            $COMMIT_HASH = git rev-parse --short HEAD
            $VERSION = "$MAJOR.$MINOR-dev.$COMMIT_COUNT+$COMMIT_HASH"
            $IS_RELEASE = "false"
            echo "âš™ å¼€å‘ç‰ˆæœ¬: $VERSION"
          }

          echo "VERSION=$VERSION" >> $env:GITHUB_OUTPUT
          echo "NEXT_VERSION=$MAJOR.$MINOR" >> $env:GITHUB_OUTPUT
          echo "IS_RELEASE=$IS_RELEASE" >> $env:GITHUB_OUTPUT

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install flet

      - name: Build with Flet
        run: |
          flet pack main.py `
            --name "EC2 Control" `
            --icon "assets/icon.ico" `
            --product-name "EC2 Control" `
            --product-version "${{ steps.semver.outputs.VERSION }}" `
            --copyright "Copyright (c) 2025 1zero" `
            --distpath dist

      - name: Verify build output
        run: |
          dir dist

      - name: Archive build artifacts
        run: |
          cd dist
          7z a -tzip "../EC2-Control-Windows.zip" "EC2 Control.exe"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: EC2-Control-Windows
          path: EC2-Control-Windows.zip
          retention-days: 30
