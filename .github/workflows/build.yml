name: Build and Package

on:
  push:
    branches: [ main, develop ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.github/**'
      - '!.github/workflows/**'
      - 'LICENSE'
      - '.gitignore'
      - '.editorconfig'
  pull_request:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.github/**'
      - '!.github/workflows/**'
      - 'LICENSE'
      - '.gitignore'
      - '.editorconfig'
  workflow_dispatch:

jobs:
  build-windows:
    name: Build Windows Application
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 获取完整历史以分析 commits

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Calculate semantic version
        id: semver
        run: |
          # 获取最近的 tag
          git fetch --tags --force
          $LATEST_TAG = git describe --tags --abbrev=0 2>$null

          if (-not $LATEST_TAG) {
            # 没有任何 tag，从 0.0 开始
            $LATEST_TAG = "v0.0"
          }

          # 解析版本号 (支持 x.x 和 x.x.x 格式，统一转为 x.x)
          if ($LATEST_TAG -match '^v?(\d+)\.(\d+)') {
            $MAJOR = [int]$matches[1]
            $MINOR = [int]$matches[2]
          } else {
            $MAJOR = 0
            $MINOR = 0
          }

          echo "最近版本: $LATEST_TAG ($MAJOR.$MINOR)"

          # 检查当前 commit 是否有 tag（已发布版本）
          $CURRENT_TAG = git describe --exact-match --tags 2>$null
          if ($CURRENT_TAG) {
            # 统一转换为 x.x 格式
            if ($CURRENT_TAG -match '^v?(\d+)\.(\d+)') {
              $VERSION = "$($matches[1]).$($matches[2])"
            } else {
              $VERSION = $CURRENT_TAG -replace '^v', ''
            }
            $IS_RELEASE = "true"
            echo "✓ 已发布版本: $VERSION"
          } else {
            # 分析从最近 tag 到现在的所有 commits
            $COMMITS = git log "$LATEST_TAG..HEAD" --pretty=format:"%s" 2>$null
            if (-not $COMMITS) {
              # 如果没有 commits，可能是初始化状态
              $COMMITS = git log --pretty=format:"%s"
            }

            $HAS_BREAKING = $false
            $HAS_FEAT = $false

            # 分析 commit messages
            foreach ($msg in $COMMITS) {
              # BREAKING CHANGE 或 feat!: 表示重大变更
              if ($msg -match '(BREAKING CHANGE|!:)') {
                $HAS_BREAKING = $true
              }
              # feat: 新功能
              if ($msg -match '^feat(\(.+\))?!?:') {
                $HAS_FEAT = $true
              }
            }

            # 根据 Conventional Commits 计算版本号 (x.x 格式)
            if ($HAS_BREAKING) {
              # BREAKING CHANGE -> Major 版本递增
              $MAJOR += 1
              $MINOR = 0
              echo "检测到 BREAKING CHANGE -> MAJOR 版本递增"
            } elseif ($HAS_FEAT) {
              # 新功能 -> Minor 版本递增
              $MINOR += 1
              echo "检测到新功能 -> MINOR 版本递增"
            } else {
              # 其他变更（fix, chore, docs 等）-> Minor 版本递增
              $MINOR += 1
              echo "其他变更 -> MINOR 版本递增"
            }

            $COMMIT_COUNT = ($COMMITS | Measure-Object).Count
            $COMMIT_HASH = git rev-parse --short HEAD
            $VERSION = "$MAJOR.$MINOR-dev.$COMMIT_COUNT+$COMMIT_HASH"
            $IS_RELEASE = "false"
            echo "开发版本: $VERSION"
          }

          echo "VERSION=$VERSION" >> $env:GITHUB_OUTPUT
          echo "NEXT_VERSION=$MAJOR.$MINOR" >> $env:GITHUB_OUTPUT
          echo "IS_RELEASE=$IS_RELEASE" >> $env:GITHUB_OUTPUT

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install flet

      - name: Install code quality tools
        run: |
          pip install ruff black isort

      - name: Code quality - Ruff lint
        run: |
          echo "运行 Ruff 语法检查..."
          ruff check src/ main.py --output-format=github
        continue-on-error: false

      - name: Code quality - Black format check
        run: |
          echo "检查代码格式 (Black)..."
          black --check src/ main.py --diff
        continue-on-error: true

      - name: Code quality - Import sorting check
        run: |
          echo "检查导入排序 (isort)..."
          isort --check-only src/ main.py --diff
        continue-on-error: true

      - name: Build with Flet
        run: |
          flet pack main.py `
            --name "EC2Control" `
            --icon "assets/icon.ico" `
            --product-name "EC2Control" `
            --product-version "${{ steps.semver.outputs.VERSION }}" `
            --copyright "Copyright (c) 2025 1zero" `
            --distpath dist

      - name: Verify build output
        run: |
          dir dist

      - name: Archive build artifacts
        run: |
          cd dist
          7z a -tzip "../EC2Control-Windows.zip" "EC2Control.exe"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: EC2Control-Windows
          path: EC2Control-Windows.zip
          retention-days: 30
