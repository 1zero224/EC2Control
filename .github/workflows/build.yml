name: Build and Package

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'src/**'
      - 'main.py'
      - 'requirements.txt'
      - 'assets/**'
      - '.github/workflows/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'src/**'
      - 'main.py'
      - 'requirements.txt'
      - 'assets/**'
      - '.github/workflows/**'
  workflow_dispatch:

jobs:
  build-windows:
    name: Build Windows Application
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history for commit analysis

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Calculate semantic version
        id: semver
        run: |
          # Fetch latest tag
          git fetch --tags --force
          $LATEST_TAG = git describe --tags --abbrev=0 2>$null

          if (-not $LATEST_TAG) {
            # No tags found, start from 0.0
            $LATEST_TAG = "v0.0"
          }

          # Parse version number (supports x.x and x.x.x formats, normalized to x.x)
          if ($LATEST_TAG -match '^v?(\d+)\.(\d+)') {
            $MAJOR = [int]$matches[1]
            $MINOR = [int]$matches[2]
          } else {
            $MAJOR = 0
            $MINOR = 0
          }

          echo "Latest version: $LATEST_TAG ($MAJOR.$MINOR)"

          # Check if current commit has a tag (released version)
          $CURRENT_TAG = git describe --exact-match --tags 2>$null
          if ($CURRENT_TAG) {
            # Normalize to x.x format
            if ($CURRENT_TAG -match '^v?(\d+)\.(\d+)') {
              $VERSION = "$($matches[1]).$($matches[2])"
            } else {
              $VERSION = $CURRENT_TAG -replace '^v', ''
            }
            $IS_RELEASE = "true"
            echo "âœ“ Released version: $VERSION"
          } else {
            # Analyze all commits from latest tag to HEAD
            $COMMITS = git log "$LATEST_TAG..HEAD" --pretty=format:"%s" 2>$null
            if (-not $COMMITS) {
              # If no commits, might be initial state
              $COMMITS = git log --pretty=format:"%s"
            }

            $HAS_BREAKING = $false
            $HAS_FEAT = $false

            # Analyze commit messages
            foreach ($msg in $COMMITS) {
              # BREAKING CHANGE or feat!: indicates breaking changes
              if ($msg -match '(BREAKING CHANGE|!:)') {
                $HAS_BREAKING = $true
              }
              # feat: new feature
              if ($msg -match '^feat(\(.+\))?!?:') {
                $HAS_FEAT = $true
              }
            }

            # Calculate version based on Conventional Commits (x.x format)
            if ($HAS_BREAKING) {
              # BREAKING CHANGE -> Major version bump
              $MAJOR += 1
              $MINOR = 0
              echo "Detected BREAKING CHANGE -> MAJOR version bump"
            } elseif ($HAS_FEAT) {
              # New feature -> Minor version bump
              $MINOR += 1
              echo "Detected new feature -> MINOR version bump"
            } else {
              # Other changes (fix, chore, docs, etc.) -> Minor version bump
              $MINOR += 1
              echo "Other changes -> MINOR version bump"
            }

            $COMMIT_COUNT = ($COMMITS | Measure-Object).Count
            $COMMIT_HASH = git rev-parse --short HEAD
            $VERSION = "$MAJOR.$MINOR-dev.$COMMIT_COUNT+$COMMIT_HASH"
            $IS_RELEASE = "false"
            echo "Development version: $VERSION"
          }

          echo "VERSION=$VERSION" >> $env:GITHUB_OUTPUT
          echo "NEXT_VERSION=$MAJOR.$MINOR" >> $env:GITHUB_OUTPUT
          echo "IS_RELEASE=$IS_RELEASE" >> $env:GITHUB_OUTPUT

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install flet

      - name: Install code quality tools
        run: |
          pip install ruff black isort

      - name: Code quality - Ruff lint
        run: |
          echo "Running Ruff lint check..."
          ruff check src/ main.py --output-format=github
        continue-on-error: false

      - name: Code quality - Black format check
        run: |
          echo "Checking code format (Black)..."
          black --check src/ main.py --diff
        continue-on-error: true

      - name: Code quality - Import sorting check
        run: |
          echo "Checking import sorting (isort)..."
          isort --check-only src/ main.py --diff
        continue-on-error: true

      - name: Build with Flet
        run: |
          flet pack main.py `
            --name "EC2Control" `
            --icon "assets/icon.ico" `
            --product-name "EC2Control" `
            --product-version "${{ steps.semver.outputs.VERSION }}" `
            --file-version "${{ steps.semver.outputs.VERSION }}" `
            --copyright "Copyright (c) 2025 1zero" `
            --distpath dist

      - name: Verify build output
        run: |
          dir dist

      - name: Archive build artifacts
        run: |
          cd dist
          7z a -tzip "../EC2Control-Windows.zip" "EC2Control.exe"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: EC2Control-Windows
          path: EC2Control-Windows.zip
          retention-days: 30
